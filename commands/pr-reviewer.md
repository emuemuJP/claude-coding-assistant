# プルリクエスト一括レビュー

## 概要
PRが作成・更新されたときに、3つのレビュー機能を一括で実行する統合プロンプト。PR記載、コード変更、ドキュメント変更をまとめてレビューし、プロジェクト定義に基づいた一貫性のあるフィードバックを提供する。

**統合レビュー機能**:
- **PR記載レビュー**: タイトル、説明文、テンプレート準拠（`@pr-description-reviewer.md`相当）
- **コードレビュー**: 変更されたソースコードの品質（`@code-reviewer.md`相当）
- **ドキュメントレビュー**: 変更された技術文章の品質（`@doc-reviewer.md`相当）

**マルチエージェント機能**: codex MCPサーバが利用可能な場合、各レビューの妥当性を検証し、より高品質なレビューを実現します。

## 使用方法
```bash
# このプロンプトの実行方法
@pr-reviewer.md PR#123をレビューしてください
@pr-reviewer.md https://github.com/owner/repo/pull/123 をレビューしてください
```

## 適用場面
- PRの総合的なレビューが必要な場合
- コード変更とドキュメント変更の両方を含むPRをレビューする場合
- チームのレビュー品質を統一したい場合
- CIパイプラインから自動レビューを実行したい場合

---

## プロンプト本文

あなたは経験豊富なシニアエンジニアです。以下の手順でプルリクエストを**総合的に**レビューし、GitHub上にコメントを投稿してください。

## 一括レビューフロー

```
1. プロジェクト定義の確認（CLAUDE.md等）
   ↓
2. PR情報の収集
   ↓
3. 変更ファイルの分類（コード/ドキュメント）
   ↓
4. 並行レビュー実行:
   ├── PR記載レビュー
   ├── コードレビュー（コード変更がある場合）
   └── ドキュメントレビュー（ドキュメント変更がある場合）
   ↓
5. Codex妥当性検証（利用可能な場合）
   ↓
6. 統合サマリーの投稿
```

## レビュー手順

### 1. プロジェクト定義の確認（重要）

まず、リポジトリ内のプロジェクト定義ファイルを確認し、レビュー基準を把握します。これらのファイルはプロジェクト固有のルール、コーディング規約、貢献ガイドラインを含んでいる場合があります。

```bash
# Claude Code プロジェクト定義の確認
cat .claude/CLAUDE.md 2>/dev/null || echo "CLAUDE.mdなし"
cat .claude/settings.json 2>/dev/null || echo "settings.jsonなし"
cat CLAUDE.md 2>/dev/null || echo "ルートCLAUDE.mdなし"

# 一般的なプロジェクト定義の確認
cat .github/CONTRIBUTING.md 2>/dev/null || cat CONTRIBUTING.md 2>/dev/null || echo "CONTRIBUTINGなし"
cat .github/CODING_GUIDELINES.md 2>/dev/null || echo "CODING_GUIDELINESなし"
cat .editorconfig 2>/dev/null || echo "editorconfigなし"

# PRテンプレートの確認
cat .github/pull_request_template.md 2>/dev/null || echo "PRテンプレートなし"

# プロジェクトの基本情報
cat README.md 2>/dev/null | head -50 || echo "READMEなし"
```

**プロジェクト定義で確認すべき項目**:
- コーディング規約（命名規則、フォーマット等）
- コミットメッセージの規約
- PR作成時のルール
- 禁止事項や必須事項
- テスト要件
- ドキュメント更新要件

**重要**: プロジェクト定義ファイルに記載されたルールは、一般的なベストプラクティスよりも優先されます。指摘を行う際は、プロジェクト固有のルールに準拠しているか確認してください。

### 2. PR情報の収集

```bash
# PR詳細情報の確認
gh pr view <PR番号> --json title,body,headRefOid,baseRefName,headRefName,author,labels,additions,deletions,changedFiles

# 変更されたファイル一覧を取得
gh pr diff <PR番号> --name-only

# PR差分の全体確認
gh pr diff <PR番号>
```

### 3. 変更ファイルの分類

変更されたファイルを以下のカテゴリに分類：

| カテゴリ | 対象ファイル | レビュー種別 |
|---------|-------------|-------------|
| コード | `.js`, `.ts`, `.py`, `.go`, `.java`, `.rb`, `.rs`, `.c`, `.cpp`, `.h`, `.cs` 等 | コードレビュー |
| ドキュメント | `.md`, `.rst`, `.txt`, `.adoc` 等 | ドキュメントレビュー |
| 設定 | `.json`, `.yaml`, `.yml`, `.toml`, `.xml`, `.env.example` 等 | コードレビュー |
| テスト | `*_test.*`, `*.test.*`, `*_spec.*`, `test_*.*` | コードレビュー |

### 4. 各レビューの実行

#### 4.1 PR記載レビュー

PRのタイトルと説明文をレビュー。以下の観点を確認：

- **タイトル**: 変更内容を簡潔に表しているか（50文字以内推奨）
- **説明文**:
  - なぜこの変更が必要か（背景・課題）
  - この変更で何が改善されるか（期待効果）
  - 影響を受けるコンポーネント/機能
- **テンプレート準拠**: 必須項目が記入されているか
- **テスト計画**: 検証方法が具体的に記載されているか
- **関連Issue**: `Closes #123` 等でリンクされているか

#### 4.2 コードレビュー（コード変更がある場合）

プロジェクト定義で指定されたルールを優先しつつ、以下の観点でレビュー：

- **機能性**: 実装が要件を満たしているか
- **可読性**: コードが理解しやすいか、命名は適切か
- **保守性**: 将来の変更に対して柔軟性があるか
- **パフォーマンス**: 効率的な実装になっているか
- **セキュリティ**: セキュリティリスクはないか
- **テスト**: 適切なテストが含まれているか
- **ドキュメント**: 必要な文書化がされているか

```bash
# コードファイルの差分確認
gh pr diff <PR番号> -- <ファイルパス>

# 変更後のファイル全体確認
cat <ファイルパス>
```

#### 4.3 ドキュメントレビュー（ドキュメント変更がある場合）

「4つのC」の観点でレビュー：

- **Clarity（明確性）**: 曖昧さなく理解できるか
- **Cohesion（論理的構造）**: 見出し階層、手順の記載が適切か
- **Completeness（完全性）**: 前提条件、期待結果が明記されているか
- **Consistency（一貫性）**: 用語・スタイルが統一されているか

```bash
# ドキュメントファイルの差分確認
gh pr diff <PR番号> -- <ファイルパス>

# 変更後のファイル全体確認
cat <ファイルパス>
```

### 5. Codexによる妥当性検証（推奨）

#### ステップ5.1: Codex動作確認

```
Hello, this is a test. Please respond with "Test successful".
```

**動作確認結果:**
- ✅ **成功**: ステップ5.2に進む
- ❌ **失敗（60秒以上応答なし）**: Codexなしで続行（ステップ6へ）

#### ステップ5.2: レビューコメントの妥当性検証

**Codexへの確認プロンプト**:
```
以下のPRレビューコメントの妥当性を検証してください：

【PR情報】
タイトル: <PRタイトル>
説明文: <PR説明文の要約>

【プロジェクト定義】
<参照したCLAUDE.md等の要約>

【レビューコメント案】
<作成したレビューコメント>

【確認観点】
1. 指摘がプロジェクト定義に準拠しているか
2. 技術的に正確か
3. 重要度の判定は適切か
4. 改善提案は実装可能で効果的か
5. 見落としている問題はないか

検証結果を以下の形式で回答してください：
- ✅ 妥当性: 高/中/低
- 📝 改善提案: （あれば）
- ⚠️ 追加指摘: （あれば）
```

### 6. レビュー結果の投稿

#### 6.1 個別コメントの投稿（重要な問題がある場合）

```bash
COMMIT_ID=$(gh pr view <PR番号> --json headRefOid --jq .headRefOid)

gh api repos/<owner>/<repo>/pulls/<PR番号>/comments \
  -F body="【<重要度>】<問題の説明>

<改善提案>

<補足説明>

---
🤖 **Reviewed by Claude Code**" \
  -F commit_id="$COMMIT_ID" \
  -F path="<ファイルパス>" \
  -F position=<diff行番号>
```

#### 6.2 統合サマリーの投稿

```bash
gh pr review <PR番号> --comment --body="## PR総合レビュー

### プロジェクト定義の確認
- [x] CLAUDE.md/プロジェクト設定を確認
- [x] PRテンプレート/コーディング規約を確認

---

### PR記載レビュー
| 項目 | 状態 | コメント |
|------|------|----------|
| タイトル | ✅/⚠️/❌ | <コメント> |
| 説明文 | ✅/⚠️/❌ | <コメント> |
| テスト計画 | ✅/⚠️/❌ | <コメント> |
| 関連Issue | ✅/⚠️/❌ | <コメント> |

---

### コードレビュー
**変更ファイル数**: <数>
**レビュー結果**:
- 🔴 重要な問題: <数>件
- 🟡 推奨改善: <数>件
- 🟢 提案: <数>件

**主な指摘事項**:
1. 【必須】<問題1の要約>
2. 【推奨】<問題2の要約>

---

### ドキュメントレビュー
**変更ファイル**: <リスト>
**レビュー結果**:
- <指摘があれば記載>

---

### 良い点
- <評価できるポイント1>
- <評価できるポイント2>

### 次のステップ
<修正が必要な場合の優先順位>

---
🤖 **Reviewed by Claude Code**
✅ **Project guidelines applied**
（Codex検証済みの場合: ✅ **Validated by Codex**）"
```

## 重要度の判定基準

| 重要度 | 基準 | 例 |
|--------|------|-----|
| **【必須】** | セキュリティ、バグ、データ損失リスク、プロジェクト定義違反 | SQLインジェクション、認証漏れ、必須項目未記入 |
| **【推奨】** | パフォーマンス、保守性、可読性の大幅改善 | N+1クエリ、重複コード、曖昧な説明 |
| **【提案】** | より良い実装・記載方法の提案 | 命名改善、補足説明の追加 |

## コメントの原則

### 良いコメント例

```markdown
【必須】プロジェクト定義違反: テストの追加が必要

CLAUDE.mdの規約により、新機能追加時はユニットテストが必須です。

改善提案:
```javascript
describe('newFeature', () => {
  it('should handle valid input', () => {
    // テストを追加
  });
});
```

参照: CLAUDE.md > Testing Requirements

---
🤖 **Reviewed by Claude Code**
✅ **Project guidelines applied**
```

### 避けるべきコメント
- プロジェクト定義を無視した一般論だけの指摘
- 具体的な改善提案を伴わない批判
- 個人的な好みに基づく指摘

## 注意事項

- **プロジェクト定義優先**: CLAUDE.md等に記載されたルールは一般的なベストプラクティスより優先
- GitHub CLI（gh）がインストール・認証済みであることを確認
- 大量の変更がある場合は、重要度の高い問題から優先的にコメント
- 建設的で具体的なフィードバックを心がける
- 初学者にも分かりやすく、専門用語には補足を入れる

## 特徴

- **統合レビュー**: PR記載、コード、ドキュメントを一括でレビュー
- **プロジェクト定義参照**: CLAUDE.md、CONTRIBUTING.md等を優先的に参照
- **効率的処理**: ファイル種別に応じた適切なレビュー観点を自動適用
- **マルチエージェント検証**: Codexによる妥当性確認（オプション）
- **体系的サマリー**: 3種類のレビュー結果を統合した分かりやすいレポート
